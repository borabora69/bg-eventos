<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BG Eventos & Hospedagem ‚Äî Barra Grande PI</title>
  <meta name="description" content="Eventos e hospedagem em Barra Grande PI. Dados atualizados via Google Sheets (CSV p√∫blico)." />
  <style>
    :root{
      --bg:#071025; --surface:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      --card:#0b1220; --text:#eaf6fb; --muted:#9aa4b2; --accent:#06b6d4; --accent-2:#7c3aed;
      --radius:12px; --gap:1rem; --max-width:1200px; --shadow:0 10px 30px rgba(2,6,23,0.6);
      --ff:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    :root[data-theme="light"]{
      --bg:linear-gradient(180deg,#f6f8fb,#eef2f7); --surface:#fff; --card:#fff; --text:#071025; --muted:#475569;
      --accent:#0ea5a4; --accent-2:#6b21a8; --shadow:0 8px 24px rgba(2,6,23,0.06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:var(--ff);background:var(--bg);color:var(--text);
      -webkit-font-smoothing:antialiased;padding:28px;display:flex;justify-content:center;
    }
    .wrap{width:100%;max-width:var(--max-width);margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021025}
    h1{margin:0;font-size:1.05rem}
    .meta{color:var(--muted);font-size:.9rem}

    .hero{display:flex;gap:18px;align-items:center;padding:18px;border-radius:14px;background:var(--surface);box-shadow:var(--shadow);margin-bottom:16px}
    .hero-left{flex:1}
    .hero-title{margin:0;font-size:1.25rem}
    .hero-sub{color:var(--muted);margin-top:6px}
    .hero-ctas{display:flex;gap:12px;align-items:center}
    .cta{padding:14px 22px;border-radius:12px;border:none;font-weight:800;cursor:pointer;font-size:1rem}
    .cta-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021025}
    .cta-secondary{background:transparent;border:2px solid rgba(255,255,255,0.06);color:var(--muted)}

    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--card);color:var(--muted);cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#021025;border:none}

    .status{color:var(--muted);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:var(--gap)}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:260px;border:1px solid rgba(255,255,255,0.03);transition:transform .18s}
    .card:hover{transform:translateY(-6px)}
    .media{height:160px;background:#021025;position:relative;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .title-row h3{margin:0;font-size:1rem}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:.95rem;color:var(--muted)}
    .small{font-size:.9rem;color:var(--muted)}
    .link{display:inline-block;padding:8px 10px;border-radius:8px;text-decoration:none;color:var(--muted);background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .link.primary{background:var(--accent);color:#021025;border:none}

    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal{background:var(--card);border-radius:12px;max-width:900px;width:100%;box-shadow:var(--shadow);overflow:hidden}
    .modal-body{display:flex;gap:12px;padding:12px}
    .modal-media{flex:1;min-height:220px;background:#021025}
    .modal-content{flex:1;display:flex;flex-direction:column;gap:8px}
    .close-btn{background:transparent;border:none;color:var(--muted);font-weight:800;cursor:pointer}

    .empty{padding:20px;border-radius:12px;background:rgba(255,255,255,0.02);color:var(--muted);text-align:center}
    footer{margin-top:18px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px}

    @media(max-width:720px){
      .hero{flex-direction:column;align-items:flex-start}
      .hero-ctas{flex-direction:column;width:100%}
      .cta{width:100%}
      .modal-body{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">BG</div>
        <div>
          <h1 id="siteTitle">BG Eventos & Hospedagem</h1>
          <div class="meta" id="siteSubtitle">Barra Grande PI ‚Ä¢ Dados via Google Sheets (CSV)</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="themeToggle" aria-pressed="false" data-i18n="theme">Tema</button>
        <button class="btn" id="langToggle" aria-pressed="false" data-i18n="lang">PT/EN</button>
      </div>
    </header>

    <div class="hero" role="region" aria-label="Hero">
      <div class="hero-left">
        <h2 class="hero-title" id="heroTitle">Encontre eventos e hospedagem em Barra Grande üèñÔ∏è</h2>
        <div class="hero-sub" id="heroSub">Atualizado automaticamente via planilha p√∫blica</div>
      </div>

      <div class="hero-ctas" role="navigation" aria-label="A√ß√µes principais">
        <button class="cta cta-primary" id="ctaEvents">üéüÔ∏è Ver Eventos</button>
        <button class="cta cta-secondary" id="ctaStays">üõèÔ∏è Ver Hospedagem</button>
      </div>
    </div>

    <main>
      <div class="controls" role="region" aria-label="Controles">
        <label class="small" data-i18n="dateRangeLabel">Buscar por datas:</label>
        <input class="input" type="date" id="dateFrom" aria-label="Data de ida">
        <input class="input" type="date" id="dateTo" aria-label="Data de volta">
        <label style="display:flex;align-items:center;gap:6px;color:var(--muted)">
          <input type="checkbox" id="praiaOnly"> <span data-i18n="beachOnly">Somente na praia</span>
        </label>
        <button class="btn primary" id="searchBtn" data-i18n="search">Buscar</button>
        <button class="btn" id="refreshBtn" data-i18n="refresh">Recarregar</button>
      </div>

      <div class="status" id="status" aria-live="polite">Carregando eventos...</div>

      <!-- EVENTOS -->
      <section id="contentEventos">
        <div id="grid" class="grid" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none" data-i18n="noEvents">Nenhum evento encontrado para os filtros selecionados.</div>
      </section>

      <!-- HOSPEDAGEM -->
      <section id="contentHospedagem" style="display:none; margin-top:18px">
        <div class="status" id="hospStatus">Carregando hospedagem...</div>
        <div id="hospGrid" class="grid" aria-live="polite"></div>
        <div id="emptyHosp" class="empty" style="display:none" data-i18n="noStays">Nenhuma hospedagem encontrada.</div>
      </section>
    </main>

    <footer>
      <div>√öltima leitura: <span id="lastUpdated">‚Äî</span></div>
      <div class="meta">Reposit√≥rio: borabora69/bg-eventos ‚Ä¢ Deploy: main</div>
    </footer>
  </div>

  <!-- Modal Quick View -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)">
        <strong id="modalTitle">Detalhes</strong>
        <button class="close-btn" id="modalClose">FECHAR</button>
      </div>
      <div class="modal-body">
        <div class="modal-media" id="modalMedia"></div>
        <div class="modal-content">
          <div id="modalDesc" style="color:var(--muted)"></div>
          <div id="modalInfo" style="color:var(--muted);font-weight:700"></div>
          <div style="margin-top:auto;display:flex;gap:8px">
            <a id="modalReserve" class="link primary" target="_blank" rel="noopener noreferrer">Reservar</a>
            <a id="modalMap" class="link" target="_blank" rel="noopener noreferrer">Ver no mapa</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ================= CONFIG =================
     Substitua as URLs abaixo pelas URLs CSV p√∫blicas:
     - CSV_EVENTS_URL: CSV da aba "EVENTOS" (pub?gid=...&output=csv)
     - CSV_HOSP_URL: CSV da aba "HOSPEDAGEM"
     Exemplo de URL: https://docs.google.com/spreadsheets/d/e/<ID>/pub?gid=<GID>&single=true&output=csv
  ===========================================*/
  const CSV_EVENTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYagiDybnUZ6o0nrMPg9OAa5af9fX5pSgc0FW1R3w_A53ueEA-xMyp3SAjpx_rIxJgBGGfic-Q3LDv/pub?gid=0&single=true&output=csv';
  const CSV_HOSP_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYagiDybnUZ6o0nrMPg9OAa5af9fX5pSgc0FW1R3w_A53ueEA-xMyp3SAjpx_rIxJgBGGfic-Q3LDv/pub?gid=123456789&single=true&output=csv';
  const IMAGE_PATH = 'img/eventos/';
  const DEFAULT_IMAGE = IMAGE_PATH + 'padrao-bg.png';
  const CACHE_BUST = false; // true para debug (for√ßa ?t=timestamp)
  const AUTO_REFRESH_MIN = 15;

  /* ================ I18N ================= */
  const I18N = {
    pt: {
      events:'Eventos', stays:'Hospedagem', theme:'Tema', lang:'PT/EN',
      dateRangeLabel:'Buscar por datas:', beachOnly:'Somente na praia',
      search:'Buscar', refresh:'Recarregar',
      noEvents:'Nenhum evento encontrado para os filtros selecionados.',
      noStays:'Nenhuma hospedagem encontrada.',
      siteTitle:'BG Eventos & Hospedagem',
      siteSubtitle:'Barra Grande PI ‚Ä¢ Dados via Google Sheets (CSV)',
      heroTitle:'Encontre eventos e hospedagem em Barra Grande üèñÔ∏è',
      heroSub:'Atualizado automaticamente via planilha p√∫blica'
    },
    en: {
      events:'Events', stays:'Stays', theme:'Theme', lang:'EN/PT',
      dateRangeLabel:'Search by dates:', beachOnly:'Only beach events',
      search:'Search', refresh:'Refresh',
      noEvents:'No events found for selected filters.',
      noStays:'No stays found.',
      siteTitle:'BG Events & Stays',
      siteSubtitle:'Barra Grande PI ‚Ä¢ Data from Google Sheets (CSV)',
      heroTitle:'Find events and stays in Barra Grande üèñÔ∏è',
      heroSub:'Automatically updated from public spreadsheet'
    }
  };

  function setLang(lang){
    lang = (lang === 'en') ? 'en' : 'pt';
    localStorage.setItem('bg_lang', lang);
    document.documentElement.lang = (lang === 'en') ? 'en' : 'pt-BR';
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n;
      if(I18N[lang] && I18N[lang][key]) el.textContent = I18N[lang][key];
    });
    document.getElementById('siteTitle').textContent = I18N[lang].siteTitle;
    document.getElementById('siteSubtitle').textContent = I18N[lang].siteSubtitle;
    document.getElementById('heroTitle').textContent = I18N[lang].heroTitle;
    document.getElementById('heroSub').textContent = I18N[lang].heroSub;
    updateStatusTexts();
  }

  function getI18n(key){
    const lang = localStorage.getItem('bg_lang') || 'pt';
    return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : I18N['pt'][key] || '';
  }

  /* ================ THEME ================= */
  function setTheme(theme){
    theme = (theme === 'light') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('bg_theme', theme);
  }

  /* ================ UTIL ================= */
  function sanitizeSlug(id){
    if(!id) return '';
    return String(id).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\-]+/g,'-').replace(/^\-+|\-+$/g,'');
  }

  function isAbsoluteUrl(u){
    try{ const url = new URL(u); return url.protocol === 'http:' || url.protocol === 'https:'; }catch(e){ return false; }
  }

  function setImageWithFallback(imgEl, imageField){
    const tries = [];
    if(!imageField){
      tries.push(DEFAULT_IMAGE);
    } else if(isAbsoluteUrl(imageField)){
      tries.push(imageField);
      tries.push(DEFAULT_IMAGE);
    } else {
      const slug = sanitizeSlug(imageField);
      tries.push(IMAGE_PATH + slug + '.png');
      tries.push(IMAGE_PATH + slug + '.jpg');
      tries.push(DEFAULT_IMAGE);
    }
    let idx = 0;
    imgEl.src = tries[idx];
    imgEl.onerror = () => { idx++; if(idx < tries.length) imgEl.src = tries[idx]; else imgEl.onerror = null; };
  }

  function parseCSV(text){
    const rows = [];
    let cur = '', inQuotes = false, row = [];
    for(let i=0;i<text.length;i++){
      const ch = text[i], nxt = text[i+1];
      if(ch === '"'){
        if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if(ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
        if(ch === '\r' && nxt === '\n'){ i++; }
        continue;
      }
      cur += ch;
    }
    if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
    return rows;
  }

  function parseDateFlexible(v){
    if(!v) return null;
    v = String(v).trim();
    const iso = new Date(v);
    if(!isNaN(iso)) return iso;
    const dmy = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(dmy) return new Date(Number(dmy[3]), Number(dmy[2]) - 1, Number(dmy[1]));
    return null;
  }

  function overlaps(rangeA, rangeB){
    if(!rangeA || !rangeB) return false;
    const aFrom = rangeA.from ? rangeA.from.getTime() : -Infinity;
    const aTo = rangeA.to ? rangeA.to.getTime() : Infinity;
    const bFrom = rangeB.from ? rangeB.from.getTime() : -Infinity;
    const bTo = rangeB.to ? rangeB.to.getTime() : Infinity;
    return (aFrom <= bTo) && (bFrom <= aTo);
  }

  function buildAffiliateUrl(url, id){
    if(!url) return '';
    try{
      const u = new URL(url);
      u.searchParams.set('utm_source','bg-site');
      u.searchParams.set('utm_medium','referral');
      u.searchParams.set('utm_campaign', id || 'link');
      return u.toString();
    }catch(e){
      return url;
    }
  }

  /* ================ STATE & UI REFS ================= */
  let RAW_EVENTS = [], RAW_HOSP = [], EVENTS = [], HOSPEDAGENS = [];
  const statusEl = document.getElementById('status');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const lastUpdated = document.getElementById('lastUpdated');
  const hospStatus = document.getElementById('hospStatus');
  const hospGrid = document.getElementById('hospGrid');
  const emptyHosp = document.getElementById('emptyHosp');

  /* ================ INIT THEME & LANG ================= */
  const savedTheme = localStorage.getItem('bg_theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme:light)').matches ? 'light' : 'dark');
  setTheme(savedTheme);
  const savedLang = localStorage.getItem('bg_lang') || 'pt';
  setLang(savedLang);

  document.getElementById('themeToggle').addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    setTheme(next);
  });
  document.getElementById('langToggle').addEventListener('click', () => {
    const current = localStorage.getItem('bg_lang') || 'pt';
    setLang(current === 'pt' ? 'en' : 'pt');
  });

  /* ================ TABS / CTAs ================= */
  document.getElementById('ctaEvents').addEventListener('click', () => switchTab('eventos'));
  document.getElementById('ctaStays').addEventListener('click', () => switchTab('hospedagem'));
  document.getElementById('tabEventos').addEventListener('click', () => switchTab('eventos'));
  document.getElementById('tabHospedagem').addEventListener('click', () => switchTab('hospedagem'));
  function switchTab(tab){
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.getElementById('contentEventos').style.display = tab === 'eventos' ? '' : 'none';
    document.getElementById('contentHospedagem').style.display = tab === 'hospedagem' ? '' : 'none';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  /* ================ SEARCH & FILTER ================= */
  document.getElementById('searchBtn').addEventListener('click', applyFilters);
  document.getElementById('refreshBtn').addEventListener('click', () => loadBothSheets(true));

  function applyFilters(){
    const fromVal = document.getElementById('dateFrom').value;
    const toVal = document.getElementById('dateTo').value;
    const praiaOnly = document.getElementById('praiaOnly').checked;
    const userRange = { from: fromVal ? new Date(fromVal) : null, to: toVal ? new Date(toVal) : null };
    const filtered = EVENTS.filter(ev => {
      if(praiaOnly){
        const desc = (ev.Descricao || '').toLowerCase();
        const praiaFlag = (ev.Praia || '').toString().toLowerCase();
        if(!(desc.includes('praia') || praiaFlag === 'x' || praiaFlag === 'sim')) return false;
      }
      if(!userRange.from && !userRange.to) return true;
      const evRange = { from: ev.Inicio || null, to: ev.Fim || null };
      return overlaps(evRange, userRange);
    });
    renderEvents(filtered);
  }

  /* ================ RENDER EVENTS (imagem, nome, data, local) ================= */
  function renderEvents(list){
    grid.innerHTML = '';
    if(!list || list.length === 0){
      empty.style.display = 'block';
      statusEl.textContent = getI18n('noEvents');
      return;
    }
    empty.style.display = 'none';
    statusEl.textContent = `${list.length} ${getI18n('events')}`;

    list.forEach(ev => {
      const card = document.createElement('article'); card.className = 'card';
      const media = document.createElement('div'); media.className = 'media';
      const img = document.createElement('img'); img.alt = ev.Nome || 'Evento'; img.loading = 'lazy';
      setImageWithFallback(img, ev.Imagem || ev.ID);
      media.appendChild(img);

      const body = document.createElement('div'); body.className = 'card-body';
      const titleRow = document.createElement('div'); titleRow.className = 'title-row';
      const h3 = document.createElement('h3'); h3.textContent = ev.Nome || 'Evento';
      titleRow.appendChild(h3);

      const metaRow = document.createElement('div'); metaRow.className = 'meta-row';
      const dates = document.createElement('div'); dates.className = 'small';
      const inicio = ev.Inicio ? ev.Inicio.toLocaleDateString() : '‚Äî';
      const fim = ev.Fim ? ev.Fim.toLocaleDateString() : '‚Äî';
      dates.textContent = `${inicio} ‚Üí ${fim}`;
      const local = document.createElement('div'); local.className = 'small'; local.textContent = ev.Local || ev.Praia || 'Barra Grande';
      metaRow.appendChild(dates); metaRow.appendChild(local);

      body.appendChild(titleRow); body.appendChild(metaRow);
      card.appendChild(media); card.appendChild(body);
      grid.appendChild(card);
    });
  }

  /* ================ RENDER HOSPEDAGENS (tudo junto) ================= */
  function renderHospedagem(list){
    hospGrid.innerHTML = '';
    if(!list || list.length === 0){
      emptyHosp.style.display = 'block';
      hospStatus.textContent = getI18n('noStays');
      return;
    }
    emptyHosp.style.display = 'none';
    hospStatus.textContent = `${list.length} hospedagem(ns)`;

    list.forEach(h => {
      const card = document.createElement('article'); card.className = 'card';
      const media = document.createElement('div'); media.className = 'media';
      const img = document.createElement('img'); img.alt = h.Nome || 'Hospedagem'; img.loading = 'lazy';
      setImageWithFallback(img, h.Imagem || h.ID || h.Nome);
      media.appendChild(img);

      const body = document.createElement('div'); body.className = 'card-body';
      const titleRow = document.createElement('div'); titleRow.className = 'title-row';
      const h3 = document.createElement('h3'); h3.textContent = (h.Nome || 'Hospedagem') + (h.Praia && (h.Praia.toString().toLowerCase()==='x' || h.Praia.toString().toLowerCase()==='sim') ? ' üèñÔ∏è' : '');
      titleRow.appendChild(h3);

      const desc = document.createElement('div'); desc.className = 'small'; desc.textContent = h.Descricao ? (h.Descricao.length > 120 ? h.Descricao.slice(0,120)+'‚Ä¶' : h.Descricao) : '';
      const metaRow = document.createElement('div'); metaRow.className = 'meta-row';
      const price = document.createElement('div'); price.textContent = h.Preco_Medio ? `R$ ${h.Preco_Medio}` : 'Pre√ßo m√©dio';
      const actions = document.createElement('div');
      const reserve = document.createElement('a'); reserve.className = 'link primary'; reserve.textContent = getI18n('stays');
      reserve.href = h.Link_Hotel ? buildAffiliateUrl(h.Link_Hotel, h.ID) : '#';
      reserve.target = '_blank'; reserve.rel = 'noopener noreferrer';
      const details = document.createElement('button'); details.className = 'link'; details.textContent = 'Detalhes';
      details.addEventListener('click', () => openModal(h));
      actions.appendChild(reserve); actions.appendChild(details);
      metaRow.appendChild(price); metaRow.appendChild(actions);

      body.appendChild(titleRow); body.appendChild(desc); body.appendChild(metaRow);
      card.appendChild(media); card.appendChild(body);
      hospGrid.appendChild(card);
    });
  }

  /* ================ MODAL ================= */
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalInfo = document.getElementById('modalInfo');
  const modalMedia = document.getElementById('modalMedia');
  const modalReserve = document.getElementById('modalReserve');
  const modalMap = document.getElementById('modalMap');
  document.getElementById('modalClose').addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => { if(e.target === modalBackdrop) closeModal(); });

  function openModal(h){
    modalTitle.textContent = h.Nome || 'Detalhes';
    modalDesc.textContent = h.Descricao || '';
    modalInfo.textContent = `${h.Local || ''} ‚Ä¢ Tel: ${h.Telefone || '‚Äî'}`;
    modalMedia.innerHTML = '';
    const img = document.createElement('img'); img.loading = 'lazy'; img.alt = h.Nome || 'Imagem'; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    setImageWithFallback(img, h.Imagem || h.ID || h.Nome);
    modalMedia.appendChild(img);
    modalReserve.href = h.Link_Hotel ? buildAffiliateUrl(h.Link_Hotel, h.ID) : '#';
    modalMap.href = h.Local ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.Local)}` : '#';
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); }

  /* ================ FETCH TWO CSVs (EVENTS + HOSP) ================= */
  async function fetchCsvText(url){
    const full = url + (CACHE_BUST ? (url.includes('?') ? '&t=' : '?t=') + Date.now() : '');
    const res = await fetch(full, { cache: 'no-cache' });
    if(!res.ok) throw new Error('CSV fetch failed: ' + res.status);
    return await res.text();
  }

  async function loadBothSheets(force=false){
    try{
      statusEl.textContent = 'Carregando dados...';
      const [eventsText, hospText] = await Promise.all([fetchCsvText(CSV_EVENTS_URL), fetchCsvText(CSV_HOSP_URL)]);
      const eventsRows = parseCSV(eventsText);
      const hospRows = parseCSV(hospText);

      if(eventsRows.length < 2 && hospRows.length < 2) throw new Error('Ambos CSVs sem dados');

      function rowsToObjects(rows){
        const headers = rows[0].map(h => h.trim());
        return rows.slice(1).map(r => {
          const obj = {};
          for(let i=0;i<headers.length;i++) obj[headers[i]] = (r[i] || '').trim();
          return obj;
        });
      }

      const eventsData = eventsRows.length >= 2 ? rowsToObjects(eventsRows) : [];
      const hospData = hospRows.length >= 2 ? rowsToObjects(hospRows) : [];

      RAW_EVENTS = eventsData; RAW_HOSP = hospData;

      // Map events
      EVENTS = eventsData.map(row => ({
        ID: row.ID || row.Slug || row.id || '',
        Nome: row.Nome || row.Name || row.nome || '',
        Inicio: parseDateFlexible(row.Inicio || row.start || ''),
        Fim: parseDateFlexible(row.Fim || row.end || ''),
        Descricao: row.Descricao || row.Description || row.descricao || '',
        Local: row.Localizacao || row.Local || row.Praia || '',
        Imagem: row.Imagem || row.Image || row.ID || ''
      }));

      // Map hospedagens
      HOSPEDAGENS = hospData.map(row => ({
        ID: row.ID || row.Slug || row.id || '',
        Nome: row.Nome || row.Name || row.nome || '',
        Preco_Medio: row.Preco_Medio || row.Preco_Hotel || row.Preco || '',
        Link_Hotel: row.Link_Afiliado || row.Link_Hotel || row.Link || '',
        Telefone: row.Telefone || row.telefone || '',
        Local: row.Localizacao || row.Local || '',
        Praia: row.Praia || '',
        Descricao: row.Descricao || row.Description || row.descricao || '',
        Imagem: row.Imagem || row.Image || row.ID || ''
      }));

      // Filter out past events
      const today = new Date(); today.setHours(0,0,0,0);
      EVENTS = EVENTS.filter(ev => { if(!ev.Fim && !ev.Inicio) return true; if(ev.Fim && ev.Fim < today) return false; return true; });
      EVENTS.sort((a,b) => (a.Inicio ? a.Inicio.getTime() : 0) - (b.Inicio ? b.Inicio.getTime() : 0));

      // Update UI
      const now = new Date();
      lastUpdated.textContent = now.toLocaleString();
      statusEl.textContent = `${EVENTS.length} ${getI18n('events')}`;
      hospStatus.textContent = `${HOSPEDAGENS.length} hospedagem(ns)`;

      renderEvents(EVENTS);
      renderHospedagem(HOSPEDAGENS);
      updateStatusTexts();

      // Debug logs
      console.log('EVENTS parsed:', EVENTS.length, EVENTS.slice(0,2));
      console.log('HOSPEDAGENS parsed:', HOSPEDAGENS.length, HOSPEDAGENS.slice(0,2));
    }catch(err){
      console.error('loadBothSheets error', err);
      statusEl.textContent = 'Erro ao carregar dados. Ver console.';
      grid.innerHTML = '';
      hospGrid.innerHTML = '';
      document.getElementById('empty').style.display = 'block';
      document.getElementById('empty').textContent = 'Erro ao carregar CSV p√∫blico. Verifique os links e o console.';
      lastUpdated.textContent = new Date().toLocaleString();
    }
  }

  function updateStatusTexts(){
    document.getElementById('status').textContent = `${EVENTS.length} ${getI18n('events')}`;
  }

  /* ================ START ================= */
  loadBothSheets();
  setInterval(() => loadBothSheets(false), AUTO_REFRESH_MIN * 60 * 1000);
  </script>
</body>
</html>
