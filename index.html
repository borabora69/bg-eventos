<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BG Eventos & Hospedagem — Barra Grande PI</title>
  <meta name="description" content="Eventos e hospedagem em Barra Grande PI. Dados atualizados via Google Sheets (CSV público)." />
  <style>
    :root{
      --bg:#071025; --card:#071827; --muted:#9aa4b2; --accent:#06b6d4; --gold:#e6b95a;
      --radius:12px; --gap:1rem; --max-width:1100px; --ff:Inter,system-ui,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--ff);background:linear-gradient(180deg,#021025,var(--bg));color:#eaf6fb;padding:24px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:var(--max-width)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021025}
    h1{margin:0;font-size:1.05rem}
    .meta{color:var(--muted);font-size:.9rem}
    nav{display:flex;gap:8px}
    .tab{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--muted);font-weight:700}
    .tab.active{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021025;border:none}
    main{margin-top:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--muted);cursor:pointer}
    .btn.primary{background:var(--accent);color:#021025;border:none}
    .status{color:var(--muted);font-size:.95rem;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--gap)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(2,6,23,0.6);display:flex;flex-direction:column}
    .media{height:160px;background:#021025;position:relative}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .title-row h3{margin:0;font-size:1rem}
    .desc{color:var(--muted);font-size:.95rem;line-height:1.3;min-height:48px}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:.95rem;color:var(--muted)}
    .link{display:inline-block;padding:8px 10px;border-radius:8px;text-decoration:none;color:var(--muted);background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .link.primary{background:var(--accent);color:#021025;border:none}
    .destaque{border:2px solid var(--gold);transform:scale(1.01)}
    .badge{position:absolute;right:10px;top:10px;background:var(--gold);color:#021025;padding:6px 8px;border-radius:999px;font-weight:800}
    .empty{padding:20px;border-radius:12px;background:rgba(255,255,255,0.02);color:var(--muted);text-align:center}
    footer{margin-top:16px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px}
    @media(max-width:640px){header{flex-direction:column;align-items:flex-start} .controls{width:100%;justify-content:space-between}}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">BG</div>
        <div>
          <h1>BG Eventos & Hospedagem</h1>
          <div class="meta">Barra Grande PI • Dados via Google Sheets (CSV)</div>
        </div>
      </div>

      <nav role="tablist" aria-label="Navegação principal">
        <button class="tab active" data-tab="eventos" id="tabEventos">Eventos</button>
        <button class="tab" data-tab="hospedagem" id="tabHospedagem">Hospedagem</button>
      </nav>
    </header>

    <main>
      <div class="controls" role="region" aria-label="Controles">
        <label class="meta" style="margin-right:8px">Buscar por datas:</label>
        <input class="input" type="date" id="dateFrom" aria-label="Data de ida">
        <input class="input" type="date" id="dateTo" aria-label="Data de volta">
        <label style="display:flex;align-items:center;gap:6px;color:var(--muted)">
          <input type="checkbox" id="praiaOnly"> <span>Somente eventos na praia</span>
        </label>
        <button class="btn primary" id="searchBtn">Buscar</button>
        <button class="btn" id="refreshBtn" title="Recarregar dados">Recarregar</button>
      </div>

      <div class="status" id="status">Carregando eventos...</div>

      <section id="contentEventos">
        <div id="grid" class="grid" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">Nenhum evento encontrado para os filtros selecionados.</div>
      </section>

      <section id="contentHospedagem" style="display:none">
        <div id="hospedagemGrid" class="grid" aria-live="polite"></div>
        <div id="emptyHosp" class="empty" style="display:none">Nenhuma hospedagem encontrada.</div>
      </section>
    </main>

    <footer>
      <div>Última leitura: <span id="lastUpdated">—</span></div>
      <div class="meta">Repositório: borabora69/bg-eventos • Deploy: main</div>
    </footer>
  </div>

  <script>
  /* CONFIG */
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYagiDybnUZ6o0nrMPg9OAa5af9fX5pSgc0FW1R3w_A53ueEA-xMyp3SAjpx_rIxJgBGGfic-Q3LDv/pub?output=csv';
  const IMAGE_PATH = 'img/eventos/';
  const DEFAULT_IMAGE = IMAGE_PATH + 'padrao-bg.png';
  const CACHE_BUST = false; // true para debug
  const AUTO_REFRESH_MIN = 15; // minutos

  /* UTIL */
  function sanitizeSlug(id){
    if(!id) return '';
    return String(id).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\-]+/g,'-').replace(/^\-+|\-+$/g,'');
  }

  function parseCSV(text){
    // parser tolerante a aspas e vírgulas internas
    const rows = [];
    let cur = '', inQuotes = false, row = [];
    for(let i=0;i<text.length;i++){
      const ch = text[i], nxt = text[i+1];
      if(ch === '"'){
        if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if(ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
        if(ch === '\r' && nxt === '\n'){ i++; }
        continue;
      }
      cur += ch;
    }
    if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
    return rows;
  }

  function parseDateFlexible(v){
    if(!v) return null;
    v = String(v).trim();
    // ISO
    const iso = new Date(v);
    if(!isNaN(iso)) return iso;
    // DD/MM/YYYY
    const dmy = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(dmy){ return new Date(Number(dmy[3]), Number(dmy[2]) - 1, Number(dmy[1])); }
    return null;
  }

  function setImageWithFallback(imgEl, id){
    const slug = sanitizeSlug(id);
    const tries = [IMAGE_PATH + slug + '.png', IMAGE_PATH + slug + '.jpg', DEFAULT_IMAGE];
    let i = 0;
    imgEl.src = tries[i];
    imgEl.onerror = () => { i++; if(i < tries.length) imgEl.src = tries[i]; else imgEl.onerror = null; };
  }

  function overlaps(rangeA, rangeB){
    // range: {from:Date, to:Date}
    if(!rangeA || !rangeB) return false;
    const aFrom = rangeA.from ? rangeA.from.getTime() : -Infinity;
    const aTo = rangeA.to ? rangeA.to.getTime() : Infinity;
    const bFrom = rangeB.from ? rangeB.from.getTime() : -Infinity;
    const bTo = rangeB.to ? rangeB.to.getTime() : Infinity;
    return (aFrom <= bTo) && (bFrom <= aTo);
  }

  /* STATE */
  let RAW = [];
  let EVENTS = [];
  let HOSPEDAGENS = [];

  /* UI refs */
  const statusEl = document.getElementById('status');
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const hospedGrid = document.getElementById('hospedagemGrid');
  const emptyHosp = document.getElementById('emptyHosp');
  const lastUpdated = document.getElementById('lastUpdated');

  /* TABS */
  document.getElementById('tabEventos').addEventListener('click', () => switchTab('eventos'));
  document.getElementById('tabHospedagem').addEventListener('click', () => switchTab('hospedagem'));
  function switchTab(tab){
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.getElementById('contentEventos').style.display = tab === 'eventos' ? '' : 'none';
    document.getElementById('contentHospedagem').style.display = tab === 'hospedagem' ? '' : 'none';
  }

  /* SEARCH */
  document.getElementById('searchBtn').addEventListener('click', applyFilters);
  document.getElementById('refreshBtn').addEventListener('click', () => loadData(true));

  function applyFilters(){
    const fromVal = document.getElementById('dateFrom').value;
    const toVal = document.getElementById('dateTo').value;
    const praiaOnly = document.getElementById('praiaOnly').checked;

    const userRange = {
      from: fromVal ? new Date(fromVal) : null,
      to: toVal ? new Date(toVal) : null
    };

    // Eventos: must overlap with userRange (if provided). If no dates provided, show all active events.
    const filtered = EVENTS.filter(ev => {
      // if praiaOnly, require 'praia' in description or Praia column
      if(praiaOnly){
        const desc = (ev.Descricao || '').toLowerCase();
        const praiaFlag = (ev.Praia || '').toLowerCase();
        if(!(desc.includes('praia') || praiaFlag === 'x' || praiaFlag === 'sim')) return false;
      }
      if(!userRange.from && !userRange.to) return true;
      const evRange = { from: ev.Inicio || null, to: ev.Fim || null };
      return overlaps(evRange, userRange);
    });

    renderEvents(filtered);
  }

  /* RENDER */
  function renderEvents(list){
    grid.innerHTML = '';
    if(!list || list.length === 0){
      empty.style.display = 'block';
      statusEl.textContent = 'Nenhum evento encontrado';
      return;
    }
    empty.style.display = 'none';
    statusEl.textContent = `${list.length} evento(s)`;

    list.forEach(ev => {
      const card = document.createElement('article');
      card.className = 'card';
      if((ev.Destaque || '').toString().toLowerCase() === 'x') card.classList.add('destaque');

      const media = document.createElement('div'); media.className = 'media';
      const img = document.createElement('img'); img.alt = ev.Nome || 'Evento'; img.loading = 'lazy';
      setImageWithFallback(img, ev.ID);
      media.appendChild(img);
      if((ev.Destaque || '').toString().toLowerCase() === 'x'){
        const b = document.createElement('div'); b.className = 'badge'; b.textContent = 'DESTAQUE'; media.appendChild(b);
      }

      const body = document.createElement('div'); body.className = 'card-body';
      const titleRow = document.createElement('div'); titleRow.className = 'title-row';
      const h3 = document.createElement('h3'); h3.textContent = ev.Nome || 'Evento';
      titleRow.appendChild(h3);

      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = ev.Descricao || '';
      const metaRow = document.createElement('div'); metaRow.className = 'meta-row';
      const dates = document.createElement('div');
      const inicio = ev.Inicio ? ev.Inicio.toLocaleDateString() : '—';
      const fim = ev.Fim ? ev.Fim.toLocaleDateString() : '—';
      dates.textContent = `${inicio} → ${fim}`;
      const price = document.createElement('div'); price.textContent = ev.Preco_Hotel ? `R$ ${ev.Preco_Hotel}` : 'Preço sob consulta';
      metaRow.appendChild(dates); metaRow.appendChild(price);

      const actions = document.createElement('div');
      const hotel = document.createElement('a'); hotel.className = 'link primary'; hotel.textContent = 'Ver hospedagem';
      hotel.href = ev.Link_Hotel ? ev.Link_Hotel : '#'; hotel.target = '_blank'; hotel.rel = 'noopener noreferrer';
      actions.appendChild(hotel);

      body.appendChild(titleRow); body.appendChild(desc); body.appendChild(metaRow); body.appendChild(actions);
      card.appendChild(media); card.appendChild(body);
      grid.appendChild(card);
    });
  }

  function renderHospedagem(list){
    hospedGrid.innerHTML = '';
    if(!list || list.length === 0){
      emptyHosp.style.display = 'block';
      return;
    }
    emptyHosp.style.display = 'none';
    list.forEach(h => {
      const card = document.createElement('article'); card.className = 'card';
      const media = document.createElement('div'); media.className = 'media';
      const img = document.createElement('img'); img.alt = h.Nome || 'Hospedagem'; img.loading = 'lazy';
      setImageWithFallback(img, h.ID || h.Slug || h.Nome);
      media.appendChild(img);
      const body = document.createElement('div'); body.className = 'card-body';
      const titleRow = document.createElement('div'); titleRow.className = 'title-row';
      const h3 = document.createElement('h3'); h3.textContent = h.Nome || 'Hospedagem';
      titleRow.appendChild(h3);
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = h.Descricao || h.Observacoes || '';
      const metaRow = document.createElement('div'); metaRow.className = 'meta-row';
      const price = document.createElement('div'); price.textContent = h.Preco_Hotel ? `R$ ${h.Preco_Hotel}` : 'Preço sob consulta';
      const link = document.createElement('a'); link.className = 'link primary'; link.textContent = 'Reservar';
      link.href = h.Link_Hotel || '#'; link.target = '_blank'; link.rel = 'noopener noreferrer';
      metaRow.appendChild(price); metaRow.appendChild(link);
      body.appendChild(titleRow); body.appendChild(desc); body.appendChild(metaRow);
      card.appendChild(media); card.appendChild(body);
      hospedGrid.appendChild(card);
    });
  }

  /* LOAD CSV */
  async function loadData(force=false){
    try{
      statusEl.textContent = 'Carregando dados...';
      const url = CSV_URL + (CACHE_BUST || force ? `?t=${Date.now()}` : '');
      const res = await fetch(url, {cache: 'no-cache'});
      if(!res.ok) throw new Error('Falha ao buscar CSV: ' + res.status);
      const text = await res.text();
      if(!text || !text.trim()) throw new Error('CSV vazio');
      const rows = parseCSV(text);
      if(rows.length < 2) throw new Error('CSV sem dados');

      const headers = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        for(let i=0;i<headers.length;i++) obj[headers[i]] = (r[i] || '').trim();
        return obj;
      });

      RAW = data;

      // Map to EVENTS and HOSPEDAGENS
      EVENTS = data.map(row => {
        return {
          ID: row.ID || row.Slug || row.id || '',
          Nome: row.Nome || row.Name || '',
          Inicio: parseDateFlexible(row.Inicio || row.start || ''),
          Fim: parseDateFlexible(row.Fim || row.end || ''),
          Descricao: row.Descricao || row.Description || '',
          Preco_Hotel: row.Preco_Hotel || row.Preco || '',
          Link_Hotel: row.Link_Hotel || row.LinkHotel || '',
          Link_Ingresso: row.Link_Ingresso || row.LinkIngresso || row.Link || '',
          Categoria: row.Categoria || row.Category || '',
          Destaque: row.Destaque || row.Destaque || '',
          Praia: row.Praia || row.Local || ''
        };
      });

      // Hospedagem: derive from same sheet or separate rows flagged (heuristic: Link_Hotel present)
      HOSPEDAGENS = EVENTS.filter(e => e.Link_Hotel && e.Link_Hotel.trim() !== '');

      // Keep only future/ongoing events (hands-off)
      const today = new Date(); today.setHours(0,0,0,0);
      EVENTS = EVENTS.filter(ev => {
        if(!ev.Fim && !ev.Inicio) return true;
        if(ev.Fim && ev.Fim < today) return false;
        return true;
      });

      // Sort by Inicio
      EVENTS.sort((a,b) => (a.Inicio ? a.Inicio.getTime() : 0) - (b.Inicio ? b.Inicio.getTime() : 0));

      // Update UI
      const now = new Date();
      lastUpdated.textContent = now.toLocaleString();
      statusEl.textContent = `${EVENTS.length} evento(s) carregado(s)`;

      // initial render
      renderEvents(EVENTS);
      renderHospedagem(HOSPEDAGENS);
    }catch(err){
      console.error(err);
      statusEl.textContent = 'Erro ao carregar dados. Ver console.';
      grid.innerHTML = '';
      hospedGrid.innerHTML = '';
      document.getElementById('empty').style.display = 'block';
      document.getElementById('empty').textContent = 'Erro ao carregar CSV público. Verifique o link e o console.';
    }
  }

  // init
  loadData();
  setInterval(() => loadData(false), AUTO_REFRESH_MIN * 60 * 1000);
  </script>
</body>
</html>
