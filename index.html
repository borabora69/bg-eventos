<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BG Eventos & Hospedagem — Barra Grande PI</title>
  <meta name="description" content="Portal de eventos e hospedagem de Barra Grande PI. Eventos atualizados automaticamente via Google Sheets CSV." />

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#06b6d4;
      --gold:#e6b95a;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --gap:1rem;
      --max-width:1100px;
      --shadow: 0 6px 18px rgba(2,6,23,0.6);
      --ff: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--ff);
      background:linear-gradient(180deg,#071025 0%,var(--bg) 100%);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:2rem;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{
      width:100%;
      max-width:var(--max-width);
      margin:0 auto;
    }

    header{
      display:flex;
      gap:1rem;
      align-items:center;
      justify-content:space-between;
      margin-bottom:1rem;
    }

    .brand{
      display:flex;
      gap:.75rem;
      align-items:center;
    }
    .logo{
      width:56px;
      height:56px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#021025;
      box-shadow:var(--shadow);
    }
    h1{font-size:1.1rem;margin:0}
    .meta{color:var(--muted);font-size:.9rem}

    .controls{
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:.5rem .75rem;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition:all .18s ease;
    }
    .btn:hover{transform:translateY(-2px); color:var(--accent)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#7c3aed); color:#021025; border:none}

    .filters{
      display:flex;
      gap:.5rem;
      align-items:center;
    }

    main{
      margin-top:1rem;
    }

    .stats{
      display:flex;
      gap:1rem;
      margin-bottom:1rem;
      color:var(--muted);
      font-size:.95rem;
      align-items:center;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:var(--gap);
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      min-height:320px;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .card:hover{transform:translateY(-6px); box-shadow:0 18px 40px rgba(2,6,23,0.7)}

    .media{
      position:relative;
      height:160px;
      background:#021025;
      display:block;
      overflow:hidden;
    }
    .media img{width:100%;height:100%;object-fit:cover;display:block}

    .card-body{
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.5rem;
      flex:1;
    }

    .title{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      align-items:flex-start;
    }
    .title h3{margin:0;font-size:1rem}
    .title .tag{font-size:.8rem;color:var(--muted)}

    .desc{color:var(--muted);font-size:.95rem;line-height:1.3;flex:1;overflow:hidden}
    .meta-row{display:flex;justify-content:space-between;gap:.5rem;align-items:center;margin-top:.5rem}
    .price{font-weight:700;color:var(--accent)}
    .actions{display:flex;gap:.5rem}

    .link{
      text-decoration:none;
      padding:.45rem .6rem;
      border-radius:8px;
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      font-weight:700;
      border:1px solid rgba(255,255,255,0.03);
    }
    .link.primary{background:var(--accent); color:#021025; border:none}

    /* Destaque */
    .destaque{
      border:2px solid var(--gold);
      transform:scale(1.02);
    }
    .badge-destaque{
      position:absolute;
      right:10px;
      top:10px;
      background:linear-gradient(90deg,var(--gold),#ffd88a);
      color:#021025;
      padding:.35rem .6rem;
      border-radius:999px;
      font-weight:800;
      font-size:.8rem;
      box-shadow:0 6px 18px rgba(230,185,90,0.12);
    }

    /* Empty / error */
    .empty{
      padding:2rem;
      text-align:center;
      color:var(--muted);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.02);
      border:1px dashed rgba(255,255,255,0.03);
    }

    footer{
      margin-top:1.25rem;
      color:var(--muted);
      font-size:.9rem;
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:center;
      flex-wrap:wrap;
    }

    @media (max-width:640px){
      header{flex-direction:column;align-items:flex-start;gap:.75rem}
      .controls{width:100%;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">BG</div>
        <div>
          <h1>BG Eventos & Hospedagem</h1>
          <div class="meta">Barra Grande PI • Eventos atualizados automaticamente</div>
        </div>
      </div>

      <div class="controls" role="region" aria-label="Controles do site">
        <div class="filters" id="categoryFilters" aria-hidden="false">
          <button class="btn" data-cat="all">Todos</button>
          <button class="btn" data-cat="Show">Show</button>
          <button class="btn" data-cat="Esporte">Esporte</button>
          <button class="btn" data-cat="Gastronomia">Gastronomia</button>
        </div>
        <button class="btn" id="refreshBtn" title="Recarregar eventos">Recarregar</button>
      </div>
    </header>

    <main>
      <div class="stats" aria-live="polite">
        <div id="status">Carregando eventos...</div>
        <div style="margin-left:auto" id="lastUpdated"></div>
      </div>

      <section id="eventsSection">
        <div id="grid" class="grid" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">Nenhum evento ativo encontrado.</div>
      </section>
    </main>

    <footer>
      <div>Atualizado automaticamente • Última atualização: <span id="footerUpdated">—</span></div>
      <div class="meta">Hospedagem estática • Repositório: borabora69/bg-eventos</div>
    </footer>
  </div>

  <script>
  /* CONFIGURAÇÃO */
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYagiDybnUZ6o0nrMPg9OAa5af9fX5pSgc0FW1R3w_A53ueEA-xMyp3SAjpx_rIxJgBGGfic-Q3LDv/pub?output=csv';
  const IMAGE_PATH = 'img/eventos/';
  const DEFAULT_IMAGE = IMAGE_PATH + 'padrao-bg.png';
  const CACHE_BUST = false; // true para forçar ?t= timestamp (usar só em debug)
  const TRACKING_BEACON = ''; // opcional: URL de coleta de cliques se houver

  /* UTILITÁRIOS */
  function sanitizeSlug(id){
    if(!id) return '';
    return String(id)
      .trim()
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9\-]+/g,'-')
      .replace(/^\-+|\-+$/g,'');
  }

  function parseCSV(text){
    // Parser simples que respeita aspas e vírgulas internas
    const rows = [];
    let cur = '', inQuotes = false, row = [];
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const nxt = text[i+1];
      if(ch === '"' ){
        if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
        inQuotes = !inQuotes;
        continue;
      }
      if(ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); row=[]; cur=''; }
        // handle \r\n
        if(ch === '\r' && nxt === '\n'){ i++; }
        continue;
      }
      cur += ch;
    }
    if(cur !== '' || row.length>0){ row.push(cur); rows.push(row); }
    return rows;
  }

  function parseDateFlexible(value){
    if(!value) return null;
    value = value.trim();
    // ISO first
    const iso = new Date(value);
    if(!isNaN(iso)) return iso;
    // Try DD/MM/YYYY or D/M/YYYY
    const dmy = value.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(dmy){
      const [_, dd, mm, yyyy] = dmy;
      return new Date(Number(yyyy), Number(mm)-1, Number(dd));
    }
    // Try MM/DD/YYYY fallback
    const mdy = value.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(mdy){
      const [_, mm, dd, yyyy] = mdy;
      return new Date(Number(yyyy), Number(mm)-1, Number(dd));
    }
    return null;
  }

  function setImageWithFallback(imgEl, id){
    const slug = sanitizeSlug(id);
    const tryList = [
      IMAGE_PATH + slug + '.png',
      IMAGE_PATH + slug + '.jpg',
      DEFAULT_IMAGE
    ];
    let idx = 0;
    imgEl.src = tryList[idx];
    imgEl.onerror = () => {
      idx++;
      if(idx < tryList.length){
        imgEl.src = tryList[idx];
      } else {
        imgEl.onerror = null;
      }
    };
  }

  function buildAffiliateUrl(url, id){
    if(!url) return '';
    try{
      const u = new URL(url);
      u.searchParams.set('utm_source','bg-site');
      u.searchParams.set('utm_medium','affiliate');
      u.searchParams.set('utm_campaign', id || 'evento');
      return u.toString();
    }catch(e){
      // se não for URL válida, retorne original
      return url;
    }
  }

  /* RENDER */
  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  const lastUpdated = document.getElementById('lastUpdated');
  const footerUpdated = document.getElementById('footerUpdated');
  const empty = document.getElementById('empty');

  let EVENTS = [];
  let CATEGORIES = new Set();
  let ACTIVE_CATEGORY = 'all';

  function renderEvents(list){
    grid.innerHTML = '';
    if(!list || list.length === 0){
      empty.style.display = 'block';
      status.textContent = 'Nenhum evento ativo encontrado.';
      return;
    }
    empty.style.display = 'none';
    status.textContent = `${list.length} evento(s) ativo(s)`;
    list.forEach(ev => {
      const card = document.createElement('article');
      card.className = 'card';
      if(ev.Destaque && String(ev.Destaque).toLowerCase() === 'x'){
        card.classList.add('destaque');
      }

      const media = document.createElement('div');
      media.className = 'media';
      const img = document.createElement('img');
      img.alt = ev.Nome || 'Imagem do evento';
      img.loading = 'lazy';
      setImageWithFallback(img, ev.ID);
      media.appendChild(img);

      if(ev.Destaque && String(ev.Destaque).toLowerCase() === 'x'){
        const badge = document.createElement('div');
        badge.className = 'badge-destaque';
        badge.textContent = 'DESTAQUE';
        media.appendChild(badge);
      }

      const body = document.createElement('div');
      body.className = 'card-body';

      const titleRow = document.createElement('div');
      titleRow.className = 'title';
      const h3 = document.createElement('h3');
      h3.textContent = ev.Nome || 'Evento sem nome';
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = ev.Categoria || '';
      titleRow.appendChild(h3);
      titleRow.appendChild(tag);

      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = ev.Descricao || '';

      const metaRow = document.createElement('div');
      metaRow.className = 'meta-row';
      const dates = document.createElement('div');
      const inicio = ev.Inicio ? new Date(ev.Inicio).toLocaleDateString() : '—';
      const fim = ev.Fim ? new Date(ev.Fim).toLocaleDateString() : '—';
      dates.textContent = `${inicio} → ${fim}`;

      const price = document.createElement('div');
      price.className = 'price';
      price.textContent = ev.Preco_Hotel ? `R$ ${ev.Preco_Hotel}` : 'Preço sob consulta';

      metaRow.appendChild(dates);
      metaRow.appendChild(price);

      const actions = document.createElement('div');
      actions.className = 'actions';
      const hotelLink = document.createElement('a');
      hotelLink.className = 'link';
      hotelLink.href = buildAffiliateUrl(ev.Link_Hotel, ev.ID);
      hotelLink.target = '_blank';
      hotelLink.rel = 'noopener noreferrer';
      hotelLink.textContent = 'Reservar Hotel';
      hotelLink.addEventListener('click', affiliateClickHandler(ev.ID, hotelLink.href));

      const ingressoLink = document.createElement('a');
      ingressoLink.className = 'link primary';
      ingressoLink.href = buildAffiliateUrl(ev.Link_Ingresso, ev.ID);
      ingressoLink.target = '_blank';
      ingressoLink.rel = 'noopener noreferrer';
      ingressoLink.textContent = 'Comprar Ingresso';
      ingressoLink.addEventListener('click', affiliateClickHandler(ev.ID, ingressoLink.href));

      actions.appendChild(hotelLink);
      actions.appendChild(ingressoLink);

      body.appendChild(titleRow);
      body.appendChild(desc);
      body.appendChild(metaRow);
      body.appendChild(actions);

      card.appendChild(media);
      card.appendChild(body);
      grid.appendChild(card);
    });
  }

  function affiliateClickHandler(id, url){
    return function(e){
      // envia beacon se configurado
      try{
        const payload = JSON.stringify({event:'affiliate_click', id, url, ts: Date.now()});
        if(TRACKING_BEACON){
          navigator.sendBeacon(TRACKING_BEACON, payload);
        } else {
          // fallback local: increment counter in localStorage
          const key = 'bg_clicks_' + (id || 'unknown');
          const prev = Number(localStorage.getItem(key) || 0);
          localStorage.setItem(key, prev + 1);
        }
      }catch(err){
        console.error('tracking error', err);
      }
      // allow navigation to proceed
    };
  }

  /* FILTROS */
  function applyCategoryFilter(cat){
    ACTIVE_CATEGORY = cat || 'all';
    document.querySelectorAll('#categoryFilters .btn').forEach(b => {
      b.classList.toggle('primary', b.dataset.cat === ACTIVE_CATEGORY);
    });
    const filtered = EVENTS.filter(ev => {
      if(ACTIVE_CATEGORY === 'all') return true;
      return (ev.Categoria || '').toLowerCase() === ACTIVE_CATEGORY.toLowerCase();
    });
    renderEvents(filtered);
  }

  document.getElementById('categoryFilters').addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-cat]');
    if(!btn) return;
    applyCategoryFilter(btn.dataset.cat);
  });

  document.getElementById('refreshBtn').addEventListener('click', () => {
    loadEvents(true);
  });

  /* FETCH E PROCESSAMENTO */
  async function loadEvents(force=false){
    try{
      status.textContent = 'Carregando eventos...';
      const url = CSV_URL + (CACHE_BUST || force ? `?t=${Date.now()}` : '');
      const res = await fetch(url, {cache: 'no-cache'});
      if(!res.ok) throw new Error('Falha ao buscar CSV: ' + res.status);
      const text = await res.text();
      if(!text || text.trim().length === 0) throw new Error('CSV vazio');
      const rows = parseCSV(text);
      if(rows.length < 2) throw new Error('CSV sem dados');
      const headers = rows[0].map(h => h.trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        for(let i=0;i<headers.length;i++){
          obj[headers[i]] = (r[i] || '').trim();
        }
        return obj;
      });

      // Normalize fields and detect optional columns
      EVENTS = data.map(row => {
        const ev = {
          ID: row.ID || row.id || row.Slug || '',
          Nome: row.Nome || row.Name || '',
          Inicio: parseDateFlexible(row.Inicio || row.start || ''),
          Fim: parseDateFlexible(row.Fim || row.end || ''),
          Descricao: row.Descricao || row.Description || '',
          Preco_Hotel: row.Preco_Hotel || row.Preco || '',
          Link_Hotel: row.Link_Hotel || row.LinkHotel || '',
          Link_Ingresso: row.Link_Ingresso || row.LinkIngresso || row.Link || '',
          Categoria: row.Categoria || row.Category || '',
          Destaque: row.Destaque || row.Destaque || ''
        };
        // fallback: infer category from description if missing
        if(!ev.Categoria){
          const d = (ev.Descricao || '').toLowerCase();
          if(d.includes('show') || d.includes('música') || d.includes('banda')) ev.Categoria = 'Show';
          else if(d.includes('futebol') || d.includes('corrida') || d.includes('esporte')) ev.Categoria = 'Esporte';
          else if(d.includes('gastronomia') || d.includes('degustação') || d.includes('chef')) ev.Categoria = 'Gastronomia';
          else ev.Categoria = 'Outros';
        }
        // collect categories
        CATEGORIES.add(ev.Categoria);
        return ev;
      });

      // Filter out past events by Fim date
      const today = new Date();
      const active = EVENTS.filter(ev => {
        if(!ev.Fim) return true; // keep if no end date
        return ev.Fim >= new Date(today.getFullYear(), today.getMonth(), today.getDate());
      });

      // Sort by Inicio asc
      active.sort((a,b) => {
        const A = a.Inicio ? a.Inicio.getTime() : 0;
        const B = b.Inicio ? b.Inicio.getTime() : 0;
        return A - B;
      });

      // Update UI
      const now = new Date();
      lastUpdated.textContent = `Última verificação: ${now.toLocaleString()}`;
      footerUpdated.textContent = now.toLocaleString();

      EVENTS = active;
      // update category buttons dynamically if new categories found
      updateCategoryButtons();
      applyCategoryFilter(ACTIVE_CATEGORY);
    }catch(err){
      console.error(err);
      status.textContent = 'Erro ao carregar eventos';
      grid.innerHTML = '';
      empty.style.display = 'block';
      empty.textContent = 'Erro ao carregar eventos. Verifique o CSV público e o console para detalhes.';
    }
  }

  function updateCategoryButtons(){
    const container = document.getElementById('categoryFilters');
    // keep default buttons, add any missing categories
    const existing = Array.from(container.querySelectorAll('button[data-cat]')).map(b => b.dataset.cat);
    CATEGORIES.forEach(cat => {
      if(!existing.includes(cat)){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.dataset.cat = cat;
        btn.textContent = cat;
        container.appendChild(btn);
      }
    });
  }

  // Inicialização
  loadEvents();

  // Auto refresh a cada 15 minutos para hands-off operation
  setInterval(() => loadEvents(false), 15 * 60 * 1000);
  </script>
</body>
</html>
